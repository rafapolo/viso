<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Viso UI - Despesas</title>
    <link href="https://fonts.googleapis.com/css2?family=Monda:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/monaco-editor@0.44.0/min/vs/loader.js"></script>
    <link rel="shortcut icon" type="image/x-icon" href="https://extrapolo.com/favicon.ico">
    <script type="module">
        import * as duckdb from 'https://cdn.jsdelivr.net/npm/@duckdb/duckdb-wasm@latest/+esm';
        
        let db;
        let conn;
        
        window.duckdbAPI = {
            async initDuckDB() {
                console.log('üöÄ Initializing DuckDB...');
                
                const JSDELIVR_BUNDLES = duckdb.getJsDelivrBundles();
                const bundle = await duckdb.selectBundle(JSDELIVR_BUNDLES);
                const worker = await duckdb.createWorker(bundle.mainWorker);
                const logger = new duckdb.ConsoleLogger();
                db = new duckdb.AsyncDuckDB(logger, worker);
                await db.instantiate(bundle.mainModule, bundle.pthreadWorker);
                
                conn = await db.connect();
                console.log('‚úÖ DuckDB initialized');
                
                return { db, conn };
            },
            
            async loadParquetData() {
                try {
                    console.log('üìÅ Loading parquet file into DuckDB...');
                    
                    const response = await fetch('./public/despesas.parquet');
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    
                    const arrayBuffer = await response.arrayBuffer();
                    console.log(`üìä Downloaded ${(arrayBuffer.byteLength / 1024 / 1024).toFixed(1)} MB`);
                    
                    await db.registerFileBuffer('despesas.parquet', new Uint8Array(arrayBuffer));
                    
                    await conn.query(`
                        CREATE VIEW despesas AS 
                        SELECT * FROM read_parquet('despesas.parquet')
                    `);
                    
                    const countResult = await conn.query("SELECT COUNT(*) as total FROM despesas");
                    const totalRecords = countResult.toArray()[0].total;
                    console.log(`‚úÖ Loaded ${totalRecords.toLocaleString()} records from parquet`);
                    
                    return totalRecords;
                    
                } catch (error) {
                    console.error('‚ùå Error loading parquet:', error);
                    throw error;
                }
            },
            
            async executeQuery(sql) {
                try {
                    const startTime = performance.now();
                    const result = await conn.query(sql);
                    const endTime = performance.now();
                    const executionTime = endTime - startTime;
                    
                    return {
                        data: result.toArray(),
                        columns: result.schema.fields.map(f => f.name),
                        rowCount: result.numRows,
                        executionTime: executionTime
                    };
                } catch (error) {
                    throw new Error(error.message);
                }
            },
            
            async getSchema() {
                try {
                    const result = await conn.query("DESCRIBE despesas");
                    return result.toArray();
                } catch (error) {
                    console.error('Error getting schema:', error);
                    return [];
                }
            }
        };
    </script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        'duckdb': {
                            50: '#fffbeb',
                            100: '#fef3c7',
                            200: '#fde68a',
                            300: '#fcd34d',
                            400: '#fbbf24', 
                            500: '#FFC000', // DuckDB yellow
                            600: '#d97706',
                            700: '#b45309',
                            800: '#92400e',
                            900: '#78350f'
                        }
                    },
                    fontFamily: {
                        'sans': ['Monda', '-apple-system', 'BlinkMacSystemFont', 'Segoe UI', 'Roboto', 'sans-serif']
                    }
                }
            }
        }
    </script>
    <style>
        .loading-spinner {
            display: inline-block;
            width: 12px;
            height: 12px;
            border: 2px solid #374151;
            border-radius: 50%;
            border-top-color: #FFC000;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .resize-handle {
            height: 4px;
            cursor: row-resize;
            position: relative;
        }

        .resize-handle:hover {
            background-color: #FFC000;
        }

    </style>
</head>
<body class="font-sans bg-white dark:bg-gray-950 text-gray-900 dark:text-white h-screen overflow-hidden">
    <div class="flex h-screen">
        <!-- Sidebar -->
        <div class="w-80 bg-gray-100 dark:bg-gray-900 border-r border-gray-300 dark:border-gray-700 flex flex-col">
            <div class="p-4 border-b border-gray-300 dark:border-gray-700 flex items-center gap-3">
                <div class="w-6 h-6 bg-duckdb-500 rounded flex items-center justify-center font-bold text-black text-sm">
                    ü¶Ü
                </div>
                <div class="text-base font-semibold">Viso UI</div>
                <button onclick="window.location.href='index.html'" class="ml-auto px-3 py-1.5 bg-gradient-to-r from-green-600 to-green-700 hover:from-green-700 hover:to-green-800 text-white rounded-lg text-xs font-medium transition-all duration-200 transform hover:scale-105 flex items-center gap-2">
                    <span>üìä</span>
                    <span>Ver Grafo</span>
                </button>
                <button id="theme-toggle" class="p-1 rounded hover:bg-gray-200 dark:hover:bg-gray-800">
                    üåô
                </button>
            </div>
            
            
            <div class="p-4 border-b border-gray-300 dark:border-gray-700">
                <div class="text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wide mb-2">Database</div>
                <div id="connection-status" class="text-xs text-gray-500 dark:text-gray-400">
                    <span class="loading-spinner"></span> Inicializando...
                </div>
            </div>
            
            <div class="p-4 border-b border-gray-300 dark:border-gray-700">
                <div class="text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wide mb-2">Esquema</div>
                <div class="text-xs" id="schema-tree">
                    <div class="text-gray-500 dark:text-gray-400 text-xs">Carregando...</div>
                </div>
            </div>
            

            <div class="p-4 flex-1 overflow-y-auto">
                <div class="text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wide mb-2">Consultas de Exemplo</div>
                <div id="sample-queries-list" class="space-y-1">
                    <div class="sample-query px-3 py-2 bg-gray-200 dark:bg-gray-800 rounded cursor-pointer text-xs transition-colors hover:bg-gray-300 dark:hover:bg-gray-700" data-query="SELECT * FROM despesas LIMIT 10">
                        üìÑ Ver primeiros 10 registros
                    </div>
                    <div class="sample-query px-3 py-2 bg-gray-200 dark:bg-gray-800 rounded cursor-pointer text-xs transition-colors hover:bg-gray-300 dark:hover:bg-gray-700" data-query="SELECT sigla_partido, COUNT(*) as total, SUM(valor_liquido) as value FROM despesas GROUP BY sigla_partido ORDER BY value DESC">
                        üìä Despesas por partido
                    </div>
                    <div class="sample-query px-3 py-2 bg-gray-200 dark:bg-gray-800 rounded cursor-pointer text-xs transition-colors hover:bg-gray-300 dark:hover:bg-gray-700" data-query="SELECT categoria_despesa, COUNT(*) as count, AVG(valor_liquido) as avg FROM despesas GROUP BY categoria_despesa ORDER BY count DESC LIMIT 10">
                        üìà Top categorias
                    </div>
                    <div class="sample-query px-3 py-2 bg-gray-200 dark:bg-gray-800 rounded cursor-pointer text-xs transition-colors hover:bg-gray-300 dark:hover:bg-gray-700" data-query="SELECT nome_parlamentar, SUM(valor_liquido) as total FROM despesas GROUP BY nome_parlamentar ORDER BY total DESC LIMIT 20">
                        üë• Top deputados
                    </div>
                    <div class="sample-query px-3 py-2 bg-gray-200 dark:bg-gray-800 rounded cursor-pointer text-xs transition-colors hover:bg-gray-300 dark:hover:bg-gray-700" data-query="SELECT fornecedor, COUNT(DISTINCT nome_parlamentar) as deputies, SUM(valor_liquido) as total FROM despesas GROUP BY fornecedor HAVING deputies > 5 ORDER BY total DESC LIMIT 15">
                        üè¢ Fornecedores multi-deputados
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="flex-1 flex flex-col">
            <div class="h-16 bg-gray-50 dark:bg-gray-900 border-b border-gray-300 dark:border-gray-700 flex items-center px-5 justify-between">
                <div class="flex items-center gap-1">
                    <div id="tabs-container" class="flex items-center gap-1">
                        <!-- Tabs will be dynamically generated here -->
                    </div>
                    <button id="new-tab-btn" class="px-3 py-1.5 border border-gray-400 dark:border-gray-600 bg-gray-200 dark:bg-gray-800 text-gray-900 dark:text-white rounded text-xs hover:bg-gray-300 dark:hover:bg-gray-700 transition-colors ml-2">
                        + Nova
                    </button>
                </div>
                
                <div class="flex items-center gap-3">
                    <button id="export-btn" class="px-3 py-1.5 border border-gray-400 dark:border-gray-600 bg-gray-200 dark:bg-gray-800 text-gray-900 dark:text-white rounded text-xs hover:bg-gray-300 dark:hover:bg-gray-700 transition-colors disabled:opacity-50 flex items-center gap-2" disabled>
                        üì§ Exportar
                    </button>
                </div>
            </div>
            
            <div class="flex-1 flex flex-col min-h-0">
                <div class="editor-container h-96 border-b border-gray-300 dark:border-gray-700">
                    <div class="h-10 bg-gray-50 dark:bg-gray-900 border-b border-gray-300 dark:border-gray-700 flex items-center px-3 gap-2">
                        <button id="run-query-btn" class="px-3 py-1.5 bg-duckdb-500 text-black rounded text-xs hover:bg-duckdb-600 transition-colors disabled:opacity-50 flex items-center gap-1.5" disabled>
                            ‚ñ∂Ô∏è Executar
                        </button>
                        <button id="clear-btn" class="px-3 py-1.5 border border-gray-400 dark:border-gray-600 bg-gray-200 dark:bg-gray-800 text-gray-900 dark:text-white rounded text-xs hover:bg-gray-300 dark:hover:bg-gray-700 transition-colors flex items-center gap-1.5">
                            üóëÔ∏è Limpar
                        </button>
                        <div class="flex-1"></div>
                        <span class="text-xs text-gray-500 dark:text-gray-400">Ctrl+Enter para executar</span>
                    </div>
                    <div id="editors-container" class="h-[calc(100%-2.5rem)] relative">
                        <!-- Editor containers will be dynamically generated here -->
                    </div>
                </div>
                
                <div class="resize-handle h-1 bg-gray-300 dark:bg-gray-700 hover:bg-duckdb-500 transition-colors" id="resize-handle"></div>

                <div class="flex-1 flex flex-col min-h-0">
                    <div class="h-10 bg-gray-50 dark:bg-gray-900 border-b border-gray-300 dark:border-gray-700 flex items-center px-3 justify-between">
                        <span class="font-medium text-sm">Resultados</span>
                        <div id="result-stats" class="text-xs text-gray-500 dark:text-gray-400"></div>
                    </div>
                    
                    <div class="flex-1 bg-gray-50 dark:bg-gray-950 min-h-0">
                        <div id="results-container" class="h-full w-full">
                            <!-- Results containers will be dynamically generated here -->
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="h-6 bg-gray-50 dark:bg-gray-900 border-t border-gray-300 dark:border-gray-700 flex items-center px-3 text-xs text-gray-500 dark:text-gray-400 justify-between">
                <div id="execution-stats">Pronto</div>
                <div id="row-count"></div>
            </div>
        </div>
    </div>

    <script>
        let currentResults = null;
        let tabs = {};
        let activeTabId = null;
        let tabCounter = 0;
        
        async function initializeApp() {
            try {
                // Initialize DuckDB
                await window.duckdbAPI.initDuckDB();
                
                // Load parquet data
                updateStatus('Carregando dados...');
                const totalRecords = await window.duckdbAPI.loadParquetData();
                
                // Load schema
                updateStatus('Carregando esquema...');
                await loadSchema();
                
                
                // Initialize Monaco Editor
                updateStatus('Configurando editor...');
                await initializeEditor();
                
                // Setup event listeners
                setupEventListeners();
                
                // Enable controls
                const runBtn = document.getElementById('run-query-btn');
                const exportBtn = document.getElementById('export-btn');
                if (runBtn) runBtn.disabled = false;
                if (exportBtn) exportBtn.disabled = false;
                
                updateStatus(`Pronto - ${totalRecords.toLocaleString()} registros carregados`);
                
            } catch (error) {
                console.error('Initialization error:', error);
                updateStatus('Erro: ' + error.message, true);
            }
        }
        
        function updateStatus(message, isError = false) {
            const statusEl = document.getElementById('connection-status');
            statusEl.innerHTML = isError ? 
                `‚ùå ${message}` : 
                `‚úÖ ${message}`;
            statusEl.className = isError ? 'text-xs text-red-500 dark:text-red-400' : 'text-xs text-duckdb-500';
        }
        
        function getDataTypeIcon(columnType) {
            const type = columnType.toUpperCase();
            
            // String/Text types
            if (type.includes('VARCHAR') || type.includes('TEXT') || type.includes('CHAR') || type.includes('STRING')) {
                return 'üìù';
            }
            
            // Integer types
            if (type.includes('BIGINT') || type.includes('INTEGER') || type.includes('INT') || type.includes('TINYINT') || type.includes('SMALLINT')) {
                return 'üî¢';
            }
            
            // Decimal/Float types
            if (type.includes('DOUBLE') || type.includes('FLOAT') || type.includes('REAL') || type.includes('DECIMAL') || type.includes('NUMERIC')) {
                return '#Ô∏è‚É£';
            }
            
            // Date/Time types
            if (type.includes('TIMESTAMP') || type.includes('DATETIME') || type.includes('DATE') || type.includes('TIME')) {
                return 'üïê';
            }
            
            // Boolean types
            if (type.includes('BOOLEAN') || type.includes('BOOL') || type.includes('BIT')) {
                return '‚òëÔ∏è';
            }
            
            // JSON/Object types
            if (type.includes('JSON') || type.includes('OBJECT')) {
                return 'üß©';
            }
            
            // Array/List types
            if (type.includes('ARRAY') || type.includes('LIST')) {
                return 'üìã';
            }
            
            // UUID types
            if (type.includes('UUID')) {
                return 'üÜî';
            }
            
            // Binary/Blob types
            if (type.includes('BLOB') || type.includes('BINARY') || type.includes('VARBINARY')) {
                return 'üì¶';
            }
            
            // Default fallback
            return 'üìå';
        }
        
        // Tab Management Functions
        function createNewTab(name = null) {
            tabCounter++;
            const tabId = `tab-${tabCounter}`;
            const tabName = name || `Consulta ${tabCounter}`;
            
            // Create tab data structure
            tabs[tabId] = {
                id: tabId,
                name: tabName,
                editor: null,
                results: null
            };
            
            // Create tab HTML elements
            createTabElements(tabId, tabName);
            
            // Switch to new tab
            switchToTab(tabId);
            
            return tabId;
        }
        
        function createTabElements(tabId, tabName) {
            // Create tab button
            const tabButton = document.createElement('div');
            tabButton.className = 'flex items-center px-4 py-2 bg-gray-200 dark:bg-gray-800 border border-gray-400 dark:border-gray-600 border-b-0 cursor-pointer text-xs rounded-t gap-2 min-w-32';
            tabButton.dataset.tabId = tabId;
            tabButton.innerHTML = `
                <span>üìù</span>
                <span class="tab-name">${tabName}</span>
                <span class="opacity-50 cursor-pointer p-0.5 rounded hover:opacity-100 hover:bg-gray-300 dark:hover:bg-gray-700 close-tab" data-tab-id="${tabId}">√ó</span>
            `;
            
            // Add click handlers
            tabButton.addEventListener('click', (e) => {
                if (!e.target.classList.contains('close-tab')) {
                    switchToTab(tabId);
                }
            });
            
            tabButton.querySelector('.close-tab').addEventListener('click', (e) => {
                e.stopPropagation();
                closeTab(tabId);
            });
            
            // Create editor container
            const editorContainer = document.createElement('div');
            editorContainer.id = `editor-${tabId}`;
            editorContainer.className = 'w-full h-full hidden';
            
            // Create results container
            const resultsContainer = document.createElement('div');
            resultsContainer.id = `results-${tabId}`;
            resultsContainer.className = 'w-full h-full hidden flex flex-col items-center justify-center text-gray-500 dark:text-gray-400 gap-2';
            resultsContainer.innerHTML = `
                <div class="text-5xl opacity-30">üìä</div>
                <div>Execute uma consulta para ver os resultados</div>
            `;
            
            // Add to containers
            document.getElementById('tabs-container').appendChild(tabButton);
            document.getElementById('editors-container').appendChild(editorContainer);
            document.getElementById('results-container').appendChild(resultsContainer);
        }
        
        function switchToTab(tabId) {
            // Remove active class from all tabs
            document.querySelectorAll('#tabs-container > div').forEach(tab => {
                tab.classList.remove('tab-active');
                tab.classList.remove('bg-gray-200', 'dark:bg-gray-800');
                tab.classList.add('bg-gray-100', 'dark:bg-gray-700');
            });
            
            // Hide all editors and results
            document.querySelectorAll('#editors-container > div').forEach(editor => {
                editor.classList.add('hidden');
            });
            
            document.querySelectorAll('#results-container > div').forEach(result => {
                result.classList.add('hidden');
            });
            
            // Show active tab
            const activeTab = document.querySelector(`[data-tab-id="${tabId}"]`);
            if (activeTab) {
                activeTab.classList.add('tab-active');
                activeTab.classList.remove('bg-gray-100', 'dark:bg-gray-700');
                activeTab.classList.add('bg-gray-200', 'dark:bg-gray-800');
            }
            
            // Show active editor and results
            const editorContainer = document.getElementById(`editor-${tabId}`);
            const resultsContainer = document.getElementById(`results-${tabId}`);
            
            if (editorContainer) editorContainer.classList.remove('hidden');
            if (resultsContainer) resultsContainer.classList.remove('hidden');
            
            // Set as active tab
            activeTabId = tabId;
            
            // Initialize editor if not already created
            if (tabs[tabId] && !tabs[tabId].editor) {
                initializeTabEditor(tabId);
            }
            
            // Update stats display
            updateTabStats(tabId);
        }
        
        function closeTab(tabId) {
            // Don't close if it's the only tab
            if (Object.keys(tabs).length <= 1) {
                return;
            }
            
            // Dispose Monaco editor
            if (tabs[tabId] && tabs[tabId].editor) {
                tabs[tabId].editor.dispose();
            }
            
            // Remove from tabs object
            delete tabs[tabId];
            
            // Remove DOM elements
            const tabButton = document.querySelector(`[data-tab-id="${tabId}"]`);
            const editorContainer = document.getElementById(`editor-${tabId}`);
            const resultsContainer = document.getElementById(`results-${tabId}`);
            
            if (tabButton) tabButton.remove();
            if (editorContainer) editorContainer.remove();
            if (resultsContainer) resultsContainer.remove();
            
            // Switch to another tab if this was active
            if (activeTabId === tabId) {
                const remainingTabs = Object.keys(tabs);
                if (remainingTabs.length > 0) {
                    switchToTab(remainingTabs[0]);
                }
            }
        }
        
        function updateTabStats(tabId) {
            const tab = tabs[tabId];
            if (tab && tab.results) {
                document.getElementById('result-stats').textContent = `${tab.results.rowCount} linhas`;
                document.getElementById('execution-stats').textContent = `Consulta executada em ${tab.results.executionTime.toFixed(2)}ms`;
            } else {
                document.getElementById('result-stats').textContent = '';
                document.getElementById('execution-stats').textContent = 'Pronto';
            }
        }
        
        async function loadSchema() {
            try {
                const schema = await window.duckdbAPI.getSchema();
                const schemaTree = document.getElementById('schema-tree');
                
                if (schema.length > 0) {
                    const schemaHTML = `
                        <div class="py-1 cursor-pointer flex items-center gap-1.5 font-medium mb-1">
                            <span class="w-3 h-3 opacity-60">üìã</span>
                            despesas (${schema.length} columns)
                        </div>
                        ${schema.map(col => 
                            `<div class="py-1 cursor-pointer flex items-center gap-1.5 ml-4 text-xs hover:text-duckdb-500">
                                <span class="w-3 h-3 opacity-60">${getDataTypeIcon(col.column_type)}</span>
                                <span>${col.column_name}</span>
                                <span class="text-gray-500 dark:text-gray-400 text-xs ml-auto">${col.column_type}</span>
                            </div>`
                        ).join('')}`;
                    schemaTree.innerHTML = schemaHTML;
                } else {
                    schemaTree.innerHTML = '<div class="text-red-500 dark:text-red-400">Falha ao carregar esquema</div>';
                }
            } catch (error) {
                document.getElementById('schema-tree').innerHTML = '<div class="text-red-500 dark:text-red-400">Erro ao carregar esquema</div>';
            }
        }
        
        async function initializeEditor() {
            return new Promise((resolve) => {
                require.config({ paths: { vs: 'https://cdn.jsdelivr.net/npm/monaco-editor@0.44.0/min/vs' } });
                require(['vs/editor/editor.main'], function () {
                    // Create the first tab
                    createNewTab('Consulta 1');
                    resolve();
                });
            });
        }
        
        function initializeTabEditor(tabId) {
            const editorContainer = document.getElementById(`editor-${tabId}`);
            if (!editorContainer || tabs[tabId].editor) return;
            
            const isDark = document.documentElement.classList.contains('dark');
            const editor = monaco.editor.create(editorContainer, {
                value: 'SELECT * FROM despesas LIMIT 10;',
                language: 'sql',
                theme: isDark ? 'vs-dark' : 'vs',
                automaticLayout: true,
                minimap: { enabled: false },
                fontSize: 13,
                lineNumbers: 'on',
                wordWrap: 'on',
                scrollBeyondLastLine: false
            });
            
            // Add keyboard shortcut for running query
            editor.addCommand(monaco.KeyMod.CtrlCmd | monaco.KeyCode.Enter, executeQuery);
            
            // Store editor reference
            tabs[tabId].editor = editor;
        }
        
        function setupEventListeners() {
            // Run query button
            const runBtn = document.getElementById('run-query-btn');
            if (runBtn) {
                runBtn.addEventListener('click', executeQuery);
            }
            
            // Clear button
            const clearBtn = document.getElementById('clear-btn');
            if (clearBtn) {
                clearBtn.addEventListener('click', () => {
                    if (activeTabId && tabs[activeTabId] && tabs[activeTabId].editor) {
                        tabs[activeTabId].editor.setValue('');
                    }
                    clearResults();
                });
            }
            
            // New tab button
            const newTabBtn = document.getElementById('new-tab-btn');
            if (newTabBtn) {
                newTabBtn.addEventListener('click', () => {
                    createNewTab();
                });
            }
            
            // Sample query buttons
            document.querySelectorAll('.sample-query').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const query = e.target.dataset.query;
                    if (activeTabId && tabs[activeTabId] && tabs[activeTabId].editor && query) {
                        tabs[activeTabId].editor.setValue(query);
                        executeQuery();
                    }
                });
            });
            
            // Export button
            const exportBtn = document.getElementById('export-btn');
            if (exportBtn) {
                exportBtn.addEventListener('click', exportResults);
            }

        }
        
        async function executeQuery() {
            if (!activeTabId || !tabs[activeTabId] || !tabs[activeTabId].editor) return;
            
            const sql = tabs[activeTabId].editor.getValue().trim();
            if (!sql) return;
            
            const runBtn = document.getElementById('run-query-btn');
            const resultsContent = document.getElementById(`results-${activeTabId}`);
            const executionStats = document.getElementById('execution-stats');
            
            try {
                // Show loading state
                runBtn.disabled = true;
                runBtn.innerHTML = '<span class="loading-spinner"></span> Executando';
                resultsContent.innerHTML = '<div class="flex flex-col items-center justify-center h-full text-gray-500 dark:text-gray-400 gap-2"><span class="loading-spinner"></span><div>Executando consulta...</div></div>';
                
                // Execute query
                const result = await window.duckdbAPI.executeQuery(sql);
                tabs[activeTabId].results = result;
                
                // Display results
                displayResults(result, activeTabId);
                
                // Update stats
                updateTabStats(activeTabId);
                
            } catch (error) {
                // Display error
                resultsContent.innerHTML = `<div class="bg-red-900/20 border border-red-500 text-red-200 p-3 m-3 rounded">
                    <strong>Erro:</strong> ${error.message}
                </div>`;
                executionStats.textContent = 'Consulta falhou';
                
            } finally {
                // Reset button
                runBtn.disabled = false;
                runBtn.innerHTML = '‚ñ∂Ô∏è Executar';
            }
        }
        
        function displayResults(result, tabId) {
            const resultsContent = document.getElementById(`results-${tabId}`);
            
            // Ensure the results container has proper classes for scrolling
            resultsContent.className = 'w-full h-full overflow-auto';
            
            if (result.rowCount === 0) {
                resultsContent.innerHTML = '<div class="flex flex-col items-center justify-center h-full text-gray-500 dark:text-gray-400 gap-2"><div class="text-2xl opacity-50">üìÑ</div><div>Nenhum resultado encontrado</div></div>';
                return;
            }
            
                // Create table
            let tableHTML = '<div class="p-4"><table class="border-collapse text-xs" style="width: auto; min-width: max-content;">';
            
            // Headers
            tableHTML += '<thead><tr>';
            result.columns.forEach(col => {
                tableHTML += `<th class="bg-gray-100 dark:bg-gray-900 text-gray-700 dark:text-gray-300 p-2 border-b border-r border-gray-300 dark:border-gray-700 font-medium text-left sticky top-0 z-10 whitespace-nowrap" style="min-width: 150px;">${col}</th>`;
            });
            tableHTML += '</tr></thead>';
            
            // Rows (limit to first 1000 for performance)
            tableHTML += '<tbody>';
            const displayRows = result.data.slice(0, 1000);
            displayRows.forEach((row, index) => {
                tableHTML += `<tr class="hover:bg-gray-100 dark:hover:bg-gray-900">`;
                result.columns.forEach(col => {
                    const value = row[col];
                    const displayValue = value === null ? '<span class="text-gray-500 dark:text-gray-400 italic">NULL</span>' : 
                                       typeof value === 'number' ? value.toLocaleString() : 
                                       String(value).length > 100 ? String(value).substring(0, 97) + '...' : 
                                       String(value);
                    tableHTML += `<td class="p-1.5 border-b border-r border-gray-300 dark:border-gray-700 whitespace-nowrap" style="min-width: 150px;">${displayValue}</td>`;
                });
                tableHTML += '</tr>';
            });
            tableHTML += '</tbody></table></div>';
            
            if (result.rowCount > 1000) {
                tableHTML += `<div class="p-3 text-center text-gray-500 dark:text-gray-400 text-xs bg-gray-100 dark:bg-gray-900">
                    Mostrando primeiras 1000 de ${result.rowCount.toLocaleString()} linhas
                </div>`;
            }
            
            resultsContent.innerHTML = tableHTML;
        }
        
        function clearResults() {
            if (!activeTabId) return;
            
            const resultsContent = document.getElementById(`results-${activeTabId}`);
            if (resultsContent) {
                resultsContent.innerHTML = '<div class="flex flex-col items-center justify-center h-full text-gray-500 dark:text-gray-400 gap-2"><div class="text-5xl opacity-30">üìä</div><div>Execute uma consulta para ver os resultados</div></div>';
            }
            
            document.getElementById('execution-stats').textContent = 'Pronto';
            document.getElementById('result-stats').textContent = '';
            
            if (tabs[activeTabId]) {
                tabs[activeTabId].results = null;
            }
        }

        
        function exportResults() {
            if (!activeTabId || !tabs[activeTabId] || !tabs[activeTabId].results || !tabs[activeTabId].results.data.length) {
                alert('Nenhum resultado para exportar');
                return;
            }
            
            const currentResults = tabs[activeTabId].results;
            
            // Convert to CSV
            const headers = currentResults.columns.join(',');
            const rows = currentResults.data.map(row => 
                currentResults.columns.map(col => {
                    const value = row[col];
                    if (value === null) return '';
                    if (typeof value === 'string' && (value.includes(',') || value.includes('"'))) {
                        return `"${value.replace(/"/g, '""')}"`;
                    }
                    return value;
                }).join(',')
            );
            
            const csv = [headers, ...rows].join('\n');
            
            // Download
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `query_results_${tabs[activeTabId].name.replace(/\s+/g, '_')}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        
        // Add resize functionality
        function initializeResize() {
            const resizeHandle = document.getElementById('resize-handle');
            const editorContainer = document.querySelector('.editor-container');
            const resultsArea = document.querySelector('.results-area');
            let isResizing = false;
            
            resizeHandle.addEventListener('mousedown', (e) => {
                isResizing = true;
                document.addEventListener('mousemove', handleResize);
                document.addEventListener('mouseup', stopResize);
                e.preventDefault();
            });
            
            function handleResize(e) {
                if (!isResizing) return;
                
                const containerRect = document.querySelector('.content-area').getBoundingClientRect();
                const newHeight = e.clientY - containerRect.top;
                const minHeight = 200;
                const maxHeight = containerRect.height - 200;
                
                if (newHeight >= minHeight && newHeight <= maxHeight) {
                    editorContainer.style.height = newHeight + 'px';
                }
            }
            
            function stopResize() {
                isResizing = false;
                document.removeEventListener('mousemove', handleResize);
                document.removeEventListener('mouseup', stopResize);
            }
        }
        
        // Add navigation functionality
        function setupNavigation() {
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', () => {
                    // Remove active state from all nav items
                    document.querySelectorAll('.nav-item').forEach(i => {
                        i.classList.remove('bg-gray-200', 'dark:bg-gray-800', 'border-r-2', 'border-duckdb-500');
                        i.classList.add('hover:bg-gray-200', 'dark:hover:bg-gray-800');
                    });
                    // Add active state to clicked item
                    item.classList.remove('hover:bg-gray-200', 'dark:hover:bg-gray-800');
                    item.classList.add('bg-gray-200', 'dark:bg-gray-800', 'border-r-2', 'border-duckdb-500');
                });
            });
        }
        
        // Add dark mode toggle functionality
        function setupThemeToggle() {
            const themeToggle = document.getElementById('theme-toggle');
            const html = document.documentElement;
            
            if (themeToggle) {
                themeToggle.addEventListener('click', () => {
                if (html.classList.contains('dark')) {
                    html.classList.remove('dark');
                    themeToggle.textContent = 'üåû';
                    document.body.className = 'font-sans bg-white text-gray-900 h-screen overflow-hidden';
                    // Update Monaco editor themes for all tabs
                    Object.values(tabs).forEach(tab => {
                        if (tab.editor) {
                            tab.editor.updateOptions({ theme: 'vs' });
                        }
                    });
                } else {
                    html.classList.add('dark');
                    themeToggle.textContent = 'üåô';
                    document.body.className = 'font-sans bg-gray-950 text-white h-screen overflow-hidden';
                    // Update Monaco editor themes for all tabs
                    Object.values(tabs).forEach(tab => {
                        if (tab.editor) {
                            tab.editor.updateOptions({ theme: 'vs-dark' });
                        }
                    });
                }
                });
            }
        }
        
        // Initialize when page loads
        window.addEventListener('load', () => {
            initializeApp();
            initializeResize();
            setupNavigation();
            setupThemeToggle();
        });
    </script>
</body>
</html>